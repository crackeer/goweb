<script src="/public/jsoneditor/9.8.0/jsoneditor.js"></script>
<link href="/public/jsoneditor/9.8.0/jsoneditor.css" rel="stylesheet">


<div id="app"></div>
<template id="template">
    <div class="row">
        <div class="col-md-2">
            <ul class="list-group">
                <template v-for="item in list">
                    <button class="list-group-item" :class="{
                        'active' : item.id == id
                    }" @click="setJSON(item)">{{item.comment}}</button>
                </template>
                
            </ul>
        </div>
        <div class="col-md-10">
            <div id="jsoneditor" style="width: 100%; height: calc(100vh - 100px);"></div>
            <button @click="save">保存</button>
        </div>
    </div>
</template>


<script text="text/javascript">
    $(document).ready(function () {
        var GEditor = null
        var vm = Vue.createApp({
            data() {
                let retData = {
                    content: {},
                    id: ''
                }
                let list = getAPIData('list_data', {
                    'list' : []
                })['list']
                console.log(list.length, list[0])
                if (list.length > 0) {
                    retData['content'] = list[0].content
                    retData['id'] = list[0].id
                }
                retData['list'] = list
                return retData
            },
            template: '#template',
            async mounted() {
                await this.initEditor()
                window.addEventListener('keydown', this.emitKeyDown)
            },
            methods: {
                async initEditor() {
                    const container = document.getElementById("jsoneditor")
                    const options = {
                        "mode": "code",
                        "search": true,
                        "indentation": 4,
                    }
                    GEditor = new JSONEditor(container, options)

                    GEditor.set(JSON.parse(this.content))
                },
                setJSON(item) {
                    this.id= item.id
                    this.content = item.content
                    GEditor.update(JSON.parse(this.content))
                },
                async save() {
                    let jsonRaw = JSON.stringify(GEditor.get())
                    let fname = window.prompt("输入描述")
                    let nowTime = dayjs().format('YYYY-MM-DD HH:mm:ss')
                    if(fname == null) {
                        fname = nowTime
                    }
                    let data = {
                        comment: fname,
                        content: jsonRaw,
                        type: 'json',
                        create_time: nowTime,
                        update_time: nowTime
                    }
                    let result = await axios.post('/api/goapi/base_code_create', data)
                    window.location.reload()
                },
                async emitKeyDown(event) {
                    console.log(event.code, event.metaKey, event, event.code == 'KeyS' && event.metaKey)
                    if(event.code == 'KeyS' && event.metaKey) {
                        alert("Save")
                        event.preventDefault()
                    }
                }
            }
        })
        vm.mount('#app')
    })
</script>