<script src="/public/jsoneditor/9.8.0/jsoneditor.js"></script>
<link href="/public/jsoneditor/9.8.0/jsoneditor.css" rel="stylesheet">


<div id="app"></div>
<template id="template">
    <div class="row">
        <div class="col-md-2">
            <ul class="list-group">
                <button class="list-group-item list-group-item-danger" style="text-align: center;" @click="clear">清空</button>
                <template v-for="item in list">
                    <button class="list-group-item" :class="{
                        'active' : item.id == id
                    }" @click="setJSON(item)">{{item.comment}}</button>
                </template>
            </ul>
            
        </div>
        <div class="col-md-10">
            <div id="jsoneditor" style="width: 100%; height: calc(100vh - 100px);"></div>
        </div>
    </div>
</template>


<script text="text/javascript">
    $(document).ready(function () {
        var GEditor = null
        var vm = Vue.createApp({
            data() {
                let retData = {
                    content: '{}',
                    id: getQuery('id') || 0,
                }
                let list = getAPIData('list_data', {
                    'list': []
                })['list']
                retData['list'] = list
                return retData
            },
            template: '#template',
            async mounted() {
                await this.initEditor()
                window.addEventListener('keydown', this.emitKeyDown)
                if (this.id > 0) {
                    this.getJSONByID(this.id)
                }
            },
            methods: {
                async initEditor() {
                    const container = document.getElementById("jsoneditor")
                    const options = {
                        "mode": "code",
                        "search": true,
                        "indentation": 4,
                    }
                    GEditor = new JSONEditor(container, options)
                    //GEditor.set(JSON.parse(this.content))
                },
                async getJSONByID(id) {
                    let result = await axios.get('/api/goapi/base_code_list?id=' + id)
                    if (result.data.code == 0 && result.data.data.list.length > 0) {
                        let data = result.data.data.list[0]
                        this.setJSON(result.data.data.list[0])
                    }
                },
                setJSON(item) {
                    this.id = item.id
                    this.content = item.content
                    GEditor.update(JSON.parse(this.content))
                    if (this.id > 0) {
                        appendQuery({
                            'id': item.id
                        })
                    } else {
                        appendQuery({
                        })
                    }

                },
                async createJSON(comment, content) {
                    let nowTime = dayjs().format('YYYY-MM-DD HH:mm:ss')
                    let data = {
                        comment: comment || nowTime,
                        content: content,
                        type: 'json',
                        create_time: nowTime,
                        update_time: nowTime
                    }
                    let result = await axios.post('/api/goapi/base_code_create', data)
                    window.location.reload()
                },
                async updateJSON(id, content) {
                    let nowTime = dayjs().format('YYYY-MM-DD HH:mm:ss')
                    let data = {
                        id: id,
                        content: content,
                        update_time: nowTime
                    }
                    let result = await axios.post('/api/goapi/base_code_update', data)
                    window.location.reload()
                },
                async emitKeyDown(event) {
                    if (event.code == 'KeyS' && event.metaKey) {
                        let content = JSON.stringify(GEditor.get())
                        event.preventDefault()

                        if (this.id < 1) {
                            bootbox.prompt({
                                title: "输入描述",
                                inputType: 'textarea',
                                callback: (result) => {
                                    if (result != null) {
                                        this.createJSON(result, content)
                                    }
                                }
                            });
                        } else {
                            await this.updateJSON(this.id, content)
                        }
                    }
                },
                async clear() {
                    this.setJSON({
                        id : 0,
                        content : '{}'
                    })
                }
            }
        })
        vm.mount('#app')
    })
</script>